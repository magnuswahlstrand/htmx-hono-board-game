<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Slay the Spire Map Example</title>
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <style>
        .node {
            cursor: pointer;
            transform-origin: 50% 50%;
        }

        .node.hoverable:hover {
            fill: orange;
        }

        .link {
            stroke: #999;
            stroke-opacity: 0.6;
        }

        body {
            background-color: darkslategray;
        }


    </style>
</head>
<body>
<svg width="400" height="450"></svg>
<script src="https://d3js.org/d3.v6.min.js"></script>
<script>
    let nodes = [
        {id: 0, type: 'start', coordinates: {x: 5, y: 0}, visited: true, links: [1, 2]},
        {id: 1, type: 'monster', coordinates: {x: 3, y: 2}, visited: false, links: [3]},
        {id: 2, type: 'monster', coordinates: {x: 7, y: 2}, visited: false, links: [4, 5]},
        {id: 3, type: 'monster', coordinates: {x: 4, y: 4}, visited: false, links: [6]},
        {id: 4, type: 'monster', coordinates: {x: 6, y: 4}, visited: false, links: [7]},
        {id: 5, type: 'camp', coordinates: {x: 8, y: 4}, visited: false, links: [7]},
        {id: 6, type: 'monster', coordinates: {x: 4.5, y: 6.5}, visited: false, links: [8]},
        {id: 7, type: 'monster', coordinates: {x: 7, y: 6.5}, visited: false, links: [8]},
        {id: 8, type: 'boss', coordinates: {x: 6, y: 8.5}, visited: false, links: []},
    ]
    let allowedNodes = [1, 2]

    let images = {
        start: 'https://pub-e405f37647b2451f9d27fc3e700b2f4f.r2.dev/start.png',
        monster: 'https://pub-e405f37647b2451f9d27fc3e700b2f4f.r2.dev/monster.png',
        boss: 'https://pub-e405f37647b2451f9d27fc3e700b2f4f.r2.dev/boss.png',
        camp: 'https://pub-e405f37647b2451f9d27fc3e700b2f4f.r2.dev/camp.png',
        punch: 'https://pub-e405f37647b2451f9d27fc3e700b2f4f.r2.dev/punch.png'
    }

    let nested = nodes.map(n => n.links.map(l => ({source: n.id, target: l})))
    let links = nested.reduce((a, b) => a.concat(b), [])


    // Initialize SVG
    let svg = d3.select("svg");

    let x = d3.scaleLinear([0, 10], [0, 400]);
    let y = d3.scaleLinear([0, 10], [400, 0]);


    // Add links
    let link = svg.append("g")
        .attr("class", "links")
        .selectAll("line")
        .data(links)
        .enter().append("line")
        .attr("class", "link")
        .attr("x1", d => x(nodes[d.source].coordinates.x))
        .attr("y1", d => y(nodes[d.source].coordinates.y))
        .attr("x2", d => x(nodes[d.target].coordinates.x))
        .attr("y2", d => y(nodes[d.target].coordinates.y));


    // Add nodes
    let nodeGroup = svg.append("g")
        .attr("class", "nodes")
        .selectAll("image")
        .data(nodes)
        .enter().append("g")

    // Add background circles
    nodeGroup.append("circle")
        .attr("r", 18) // Radius of the circle
        .attr("cx", d => x(d.coordinates.x))
        .attr("cy", d => y(d.coordinates.y))
        .attr("fill", "darkslategray")

    let diameter = 30
    let maxDiameter = 50

    function loopAnimation(d, d2, foo) {
        d3.select(this)
            .transition()
            .duration(600)
            .attr("width", maxDiameter)
            .attr("height", maxDiameter)
            .attr("x", x(d.coordinates.x) - maxDiameter / 2)
            .attr("y", y(d.coordinates.y) - maxDiameter / 2)
            .transition()
            .duration(600)
            .attr("width", diameter)
            .attr("height", diameter)
            .attr("x", x(d.coordinates.x) - diameter / 2)
            .attr("y", y(d.coordinates.y) - diameter / 2)
            .on('end', loopAnimation)
    }

    nodeGroup.append("image")
        .attr("xlink:href", d => images[d.type])
        .attr("width", 30)
        .attr("height", 30)
        .attr("x", d => x(d.coordinates.x) - 15)
        .attr("y", d => y(d.coordinates.y) - 15)
        .attr("opacity", d => d.visited || allowedNodes.includes(d.id) ? 1 : 0.3)
        .filter(d => allowedNodes.includes(d.id))
        .on('click', handleClick)
        .attr("class", "node")
        .each(loopAnimation)

    // Handle click
    function handleClick(event, d) {
        const selector = `#node-${d.id}`
        htmx.trigger(selector, "trigger-submit");
    }
</script>
</body>
</html>